<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="tabletninjas-header.html">
<link rel="import" href="shared-styles.html">

<dom-module id="tabletninjas-tag">
  <style include="shared-styles">
    :host {
      display: block;
      background-color: black;
    }
    /*#flex-container{
      display: flex;
      flex-direction: column;
    }*/
    #Tablet{
      width: 100%;
      position: absolute;
    }
    #imageArea{
      position: relative;
    }
    #footer-container {
      width: 100%;
      background-color: black;
      position: fixed;
      bottom:0px;
      opacity: .85;
    }
    #signs{
      overflow: auto;
      white-space: nowrap;
    }
    #signs > * {
      vertical-align: middle;
    }
    #signs #signs-scroll {
      display: inline-block;
    }
    #signs img {
      width: 11%;
      display: inline-block;
      /*maybe figure out a way to get the images on the same line and to scroll?*/
    }
    .graph {
      background-color: orange;
      display: block;
    }
    .big{
      --iron-icon-fill-color: white;

      --iron-icon-width: 5%;
      border-color: white;
      border-style: solid;
      border-radius:15%
    }

  </style>
  <template>
    <tabletninjas-header></tabletninjas-header>
    <div id = "imageArea">
      <img id ='Tablet' class = "hbwrap droppable">
      <!-- src ="../images/KUG03-obv-01.jpg" -->
    </div>
    <div id = "footer-container">
      <center><div class ="black-background" id><iron-icon class = "big" icon="arrow-back"></iron-icon><span style="color:white">Line 1</span><iron-icon class = "big" icon="arrow-forward"></iron-icon></div></center>
      <div id = "signs">
        <span id = "signs-scroll">
          <img src ="../images/signs/001.png" id="one" data-sign='001'>
          <img src ="../images/signs/002a.png" id="two" data-sign='002a'>
          <img src ="../images/signs/001.png" id="three" data-sign='001'>
          <img src ="../images/signs/002a.png" id="four" data-sign='002a'>
          <img src ="../images/signs/001.png" id="five" data-sign='001'>
          <img src ="../images/signs/002a.png" id="six" data-sign='002a'>
          <img src ="../images/signs/001.png" id="seven" data-sign='001'>
          <img src ="../images/signs/001.png" id="eight" data-sign='001'>
          <img src ="../images/signs/001.png" id="nine" data-sign='001'>
          <img src ="../images/signs/001.png" id="ten" data-sign='001'>
        </span>
      </div>
    </div>
  </template>
  <!-- <script src = "../bower_components/interactjs/interact.js"></script> -->
  <script
    src="https://code.jquery.com/jquery-3.1.1.js"
    integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA="
    crossorigin="anonymous">
  </script>
  <script
  src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
  integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
  crossorigin="anonymous">
  </script>
  <!-- <script src = "tag-hotspots.js"> -->

  </script>
  <script>
    Polymer({
      is: 'tabletninjas-tag',
      properties: {
        username: String
      },
      ready: function() {
        firebase.auth().onAuthStateChanged(function(user) {
          if (!user) {
            //change this to profile once the profile page is created.
            window.location = "/login"
          }
        });
        var user = firebase.auth().currentUser;
        //Custom
        //GLOBAL VARIABLES
        var self = this;
        var tabletDropArea = this.root.querySelector('#Tablet')
        var tabletID, tabletSeason, tabletNumber, tabletView, tabletAngle;
        var hotspotArray = [];

        $(this.root.querySelector('#Tablet')).on('load', function(){
          var height = $(this).css('height')
          var footerHeight = self.root.querySelector('#footer-container').offsetHeight;
          $(self.shadowRoot.querySelector('#imageArea')).css({'height': height, 'margin-bottom': footerHeight});
          //var tabletHotspots = getHotspots();
          // tabletHotspots.then(function(data) {
          //   for (var key in data) {
          //      if (data.hasOwnProperty(key)) {
          //         var obj = data[key];
          //         newHotspot = new hotspot((hotspotArray.length + 1), obj.left, obj.top, obj.width, obj.height, obj.sign);
          //         hotspotArray.push(newHotspot);//set position and height of image
          //         newHotspot.attachHotspot()
          //      }
          //   }
          // })
        })

        function getHotspots() {
          return new Promise(function(resolve, reject) {
            try{
              var tabletHotspots = 'tablets/' + tabletSeason + '/' + tabletNumber + '/' + tabletView + '/' + tabletAngle + '/hotspots'
              firebase.database().ref('hotspotPath').once('value').then(function(snapshot) {
                resolve(snapshot.val());
              });
            }catch(error){
              reject(Error(error))
            }
          })
        }
        var tabletImagePath = getTabletImagePath();

        function getTabletImagePath() {
          return new Promise(function(resolve, reject) {
            try{
              firebase.database().ref('tablets/Kt94k').orderByKey().limitToFirst(1).once('value').then(function(snapshot) {
                var path = getTabletImagePathChildInfo(snapshot);
                resolve(path);
              });
            }catch(error){
              reject(Error(error))
            }
          })
        }
        tabletImagePath.then(function(data) {

            ///////////?THIS NEEDS TO GO IN A DEFFERRED
          //change this once we get to Production
          var pathReference = firebase.storage().ref(data.path);
          pathReference.getDownloadURL().then(function(url){
            var img = self.root.querySelector('#Tablet');
            img.src = url;
          }).catch(function(error){
            console.log('error', error)
          })
        })
        function getTabletImagePathChildInfo(snapshot){
          return new Promise(function(resolve, reject) {
            try{
              snapshot.forEach(function(childSnapshot) {
                if(childSnapshot.hasChild('hasLines')){
                  console.log('has lines has fired!')
                }
                loc = '';
                var path = childSnapshot.key;
                var found = false;
                var hasLines = false;
                var i = 0;
                found === false
                while(found === false){
                  checkChildren(snapshot.child(path).val());
                }
                function checkChildren(obj){
                  for(child in obj){
                    if(obj.hasOwnProperty('lines')){
                      hasLines = true;
                    }
                    if(obj.hasOwnProperty('location')){
                      loc = obj['location']
                      tabletNumber = obj['number']
                      tabletSeason = obj['season']
                      tabletView = obj['view']
                      tabletAngle = obj['angle']
                      found = true;
                    }
                    path = path + '/' + child ;
                    return child;
                  }
                }
                if(hasLines){
                  console.log('yes indeed there are lines')
                  var fullPath = 'tablets/Kt94k' + '/' + tabletNumber + '/' + loc;
                  resolve({acceptImage: true, path: fullPath});
                }else{
                  var fullPath = 'tablets/Kt94k' + '/' + tabletNumber + '/' + loc;
                  resolve({acceptImage: false, key: childSnapshot.key, path: fullPath});
                  //return(childSnapshot.key)
                }
              });
            }catch(error){
              reject(Error(error))
            }
          })
        }
        function getTabletImagePathWithStartingIndex(index) {
          return new Promise(function(resolve, reject){
            try{
              firebase.database().ref('tablets/Kt94k').orderByKey().startAt(index).limitToFirst(2).once('value').then(function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                  if(childSnapshot.key != index)
                    loc = '';
                    var path = childSnapshot.key;
                    var found = false;
                    var hasLines = false;
                    var i = 0;
                    found === false
                    while(found === false){
                      checkChildren(snapshot.child(path).val());
                    }
                    function checkChildren(obj){
                      for(child in obj){
                        if(obj.hasOwnProperty('lines')){
                          hasLines = true;
                        }
                        if(obj.hasOwnProperty('location')){
                          loc = obj['location']
                          tabletNumber = obj['number']
                          tabletSeason = obj['season']
                          tabletView = obj['view']
                          tabletAngle = obj['angle']
                          found = true;
                        }
                        path = path + '/' + child ;
                        return child;
                      }
                    }
                    if(hasLines){
                      var fullPath = 'tablets/Kt94k' + '/' + tabletNumber + '/' + loc;
                      //resolve({acceptImage: true, path: fullPath});
                      resolve(fullPath);
                    }else{
                      getTabletImagePathWithStartingIndex(path)
                      .then(function(){
                        var fullPath = 'tablets/Kt94k' + '/' + tabletNumber + '/' + loc;
                        resolve(fullPath);
                      });
                      // var fullPath = 'tablets/Kt94k' + '/' + tabletNumber + '/' + loc;
                      // resolve({acceptImage: false, key: childSnapshot.key, path: fullPath});
                      //return(childSnapshot.key)
                    }
                })
                //resolve('nothing yet');
              });
            }catch(error){
              reject(Error(error))
            }
          });
        }

        //Set up a Rectangle spot

        function hotspot (id, left, top, width, height, sign){
          console.log('hotspot function')
          this.id = id;
          this.x = left;
          this.y = top;
          this.width = width;
          this.height = height;
          this.html = "<img src='../images/signs/" + sign + ".png' id = '"+ 'one' + "' class='graph'>"//get the correct ID from Firebase
        }
        hotspot.prototype.attachHotspot = function(){
          var tablet = self.shadowRoot.querySelector('#Tablet');
          var left = (this.x) * 100;
          var top = (this.y) * 100;
          var width = tablet.width * this.width;
          var height = tablet.height * this.height;
          var attachedGraph = $(this.html).clone();
          var imageAreaDrop = self.shadowRoot.querySelector('#imageArea');
          var imageHTML = '<img style="background-color: black; position: absolute; left:'+ left+ '%; top:'+ top+ '%; width:'+ width+ 'px; height:'+ height+ 'px;" src="'+ attachedGraph[0].src +'">';
          $(imageAreaDrop).append(imageHTML)
          //TO DO: RESIZE THE HOTSPOTS ON A WINDOW RESIZE
        }

        //make each of the signs draggable
        var nodes = this.root.querySelector('#signs-scroll').childNodes
        for (i = 0; i < nodes.length; i++){
          if (nodes[i].nodeName.toLowerCase() == 'img') {
            $(nodes[i]).draggable({
              helper: 'clone',
            });
           }
        }

        $(tabletDropArea).droppable({
          drop: function( event, ui ) {
            console.log('tablet drop')
            var currentDraggable = $(ui.helper)[0];
            //Calculate position
            var signDataPoints = calculateSignPercentages($(currentDraggable).offset().left, $(tabletDropArea).offset().left, $(currentDraggable).offset().top, $(tabletDropArea).offset().top, currentDraggable.width, tabletDropArea.width, currentDraggable.height, tabletDropArea.height)
            var firebaseHotspot = saveHotspot(signDataPoints.left, signDataPoints.top, signDataPoints.width, signDataPoints.height, currentDraggable.dataset.sign)
            newHotspot = new hotspot((hotspotArray.length + 1), signDataPoints.left, signDataPoints.top, signDataPoints.width, signDataPoints.height, currentDraggable.dataset.sign);
            hotspotArray.push(newHotspot);//set position and height of image
            newHotspot.attachHotspot()
          }
        });

        function calculateSignPercentages(uix, tabletx, uiy, tablety, uiwidth, tabletwidth, uiheight, tabletheight){
          console.log('calc sign percentages')
          return {
            left: ((uix - tabletx)/(tabletwidth - tabletx)),
            top: ((uiy - tablety)/(tabletheight - tablety)),
            width: (uiwidth/tabletwidth),
            height: (uiheight/tabletheight),
          }
        } //calculateSignPercentages
        function saveHotspot (left, top, width, height, sign){
          console.log('saveHotspot')
          var hotspotPath = tabletSeason + '/' + tabletNumber + '/' + tabletView + '/' + tabletAngle;
          var date = new Date().getTime();
          var hotspotData = {
            left,
            top,
            width,
            height,
            sign,
            date,
          }
          var hotspotCopy = hotspotData
          firebase.database().ref('tablets/' + hotspotPath + '/hotspots').push(hotspotData);
          firebase.database().ref('users/'+ user.uid + '/hotspots/' + hotspotPath).push(hotspotCopy)
        }//saveHotspot

      }//Ready
    });//Polymer
  </script>
</dom-module>
